{"version":3,"file":"patterns.cjs","sources":["../../../../src/src/engine/metadata/patterns.js"],"sourcesContent":["/*!\n * Copyright (c) 2017-present Cliqz GmbH. All rights reserved.\n *\n * This Source Code Form is subject to the terms of the Mozilla Public\n * License, v. 2.0. If a copy of the MPL was not distributed with this\n * file, You can obtain one at https://mozilla.org/MPL/2.0/.\n */\nimport { CompactMap } from '../map';\nimport { sizeOfUTF8, sizeOfLength } from '../../data-view';\nimport NetworkFilter from '../../filters/network';\n/**\n * This function takes an object representing a pattern from TrackerDB dump\n * and validates its shape. The result is the same object, but strongly typed.\n */\nexport function isValid(pattern) {\n    if (pattern === null) {\n        return false;\n    }\n    if (typeof pattern !== 'object') {\n        return false;\n    }\n    const { key, name, category, organization, alias, website_url: websiteUrl, domains, filters, } = pattern;\n    if (typeof key !== 'string') {\n        return false;\n    }\n    if (typeof name !== 'string') {\n        return false;\n    }\n    if (typeof category !== 'string') {\n        return false;\n    }\n    if (organization !== null && typeof organization !== 'string') {\n        return false;\n    }\n    if (typeof alias !== 'string' && alias !== null) {\n        return false;\n    }\n    if (websiteUrl !== null && typeof websiteUrl !== 'string') {\n        return false;\n    }\n    if (!Array.isArray(domains) || !domains.every((domain) => typeof domain === 'string')) {\n        return false;\n    }\n    if (!Array.isArray(filters) || !filters.every((filter) => typeof filter === 'string')) {\n        return false;\n    }\n    return true;\n}\nexport function getKeys(pattern) {\n    const keys = [];\n    for (const filter of pattern.filters) {\n        const parsedFilter = NetworkFilter.parse(filter);\n        if (parsedFilter !== null) {\n            keys.push(parsedFilter.getId());\n        }\n    }\n    for (const domain of pattern.domains) {\n        const parsedFilter = NetworkFilter.parse(`||${domain}^`);\n        if (parsedFilter !== null) {\n            keys.push(parsedFilter.getId());\n        }\n    }\n    return [...new Set(keys)];\n}\nexport function getSerializedSize(pattern) {\n    let sizeOfDomains = sizeOfLength(pattern.domains.length);\n    for (const domain of pattern.domains) {\n        sizeOfDomains += sizeOfUTF8(domain);\n    }\n    let sizeOfFilters = sizeOfLength(pattern.filters.length);\n    for (const filter of pattern.filters) {\n        sizeOfFilters += sizeOfUTF8(filter);\n    }\n    return (sizeOfUTF8(pattern.key) +\n        sizeOfUTF8(pattern.name) +\n        sizeOfUTF8(pattern.category) +\n        sizeOfUTF8(pattern.organization || '') +\n        sizeOfUTF8(pattern.alias || '') +\n        sizeOfUTF8(pattern.website_url || '') +\n        sizeOfUTF8(pattern.ghostery_id || '') +\n        sizeOfDomains +\n        sizeOfFilters);\n}\nexport function serialize(pattern, view) {\n    view.pushUTF8(pattern.key);\n    view.pushUTF8(pattern.name);\n    view.pushUTF8(pattern.category);\n    view.pushUTF8(pattern.organization || '');\n    view.pushUTF8(pattern.alias || '');\n    view.pushUTF8(pattern.website_url || '');\n    view.pushUTF8(pattern.ghostery_id || '');\n    view.pushLength(pattern.domains.length);\n    for (const domain of pattern.domains) {\n        view.pushUTF8(domain);\n    }\n    view.pushLength(pattern.filters.length);\n    for (const filter of pattern.filters) {\n        view.pushUTF8(filter);\n    }\n}\nexport function deserialize(view) {\n    const key = view.getUTF8();\n    const name = view.getUTF8();\n    const category = view.getUTF8();\n    const organization = view.getUTF8() || null;\n    const alias = view.getUTF8() || null;\n    const website_url = view.getUTF8() || null;\n    const ghostery_id = view.getUTF8() || null;\n    const numberOfDomains = view.getLength();\n    const domains = [];\n    for (let i = 0; i < numberOfDomains; i += 1) {\n        domains.push(view.getUTF8());\n    }\n    const numberOfFilters = view.getLength();\n    const filters = [];\n    for (let i = 0; i < numberOfFilters; i += 1) {\n        filters.push(view.getUTF8());\n    }\n    return {\n        key,\n        name,\n        category,\n        organization,\n        alias,\n        website_url,\n        ghostery_id,\n        domains,\n        filters,\n    };\n}\nexport function createMap(patterns) {\n    return new CompactMap({\n        getSerializedSize,\n        getKeys,\n        serialize,\n        deserialize,\n        values: patterns,\n    });\n}\n//# sourceMappingURL=patterns.js.map"],"names":["NetworkFilter","sizeOfLength","sizeOfUTF8","CompactMap"],"mappings":"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"}