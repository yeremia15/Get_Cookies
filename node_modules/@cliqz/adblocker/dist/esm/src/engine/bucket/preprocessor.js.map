{"version":3,"file":"preprocessor.js","sources":["../../../../src/src/engine/bucket/preprocessor.js"],"sourcesContent":["import Preprocessor from '../../preprocessor';\nexport default class PreprocessorBucket {\n    static deserialize(view) {\n        const excluded = new Set();\n        for (let i = 0, l = view.getUint32(); i < l; i++) {\n            excluded.add(view.getUint32());\n        }\n        const preprocessors = [];\n        for (let i = 0, l = view.getUint32(); i < l; i++) {\n            preprocessors.push(Preprocessor.deserialize(view));\n        }\n        return new this({\n            excluded,\n            preprocessors,\n        });\n    }\n    constructor({ excluded = new Set(), preprocessors = [], }) {\n        this.excluded = excluded;\n        this.preprocessors = preprocessors;\n    }\n    isFilterExcluded(filter) {\n        return this.excluded.has(filter.getId());\n    }\n    updateEnv(env) {\n        // Update excluded filter ids based on bindings\n        this.excluded.clear();\n        for (const preprocessor of this.preprocessors) {\n            if (!preprocessor.evaluate(env)) {\n                for (const filterID of preprocessor.filterIDs) {\n                    this.excluded.add(filterID);\n                }\n            }\n        }\n    }\n    update({ added, removed, }, env) {\n        if (removed) {\n            for (const preprocessor of removed) {\n                const local = this.preprocessors.find((local) => local.condition === preprocessor.condition);\n                // Skip if we don't have any preprocessor on local\n                // In the context of filters updates from CDN this should never happen.\n                if (!local) {\n                    continue;\n                }\n                for (const filterID of preprocessor.filterIDs) {\n                    local.filterIDs.delete(filterID);\n                }\n            }\n        }\n        if (added) {\n            for (const preprocessor of added) {\n                const local = this.preprocessors.find((local) => local.condition === preprocessor.condition);\n                if (!local) {\n                    this.preprocessors.push(preprocessor);\n                    continue;\n                }\n                for (const filterID of preprocessor.filterIDs) {\n                    local.filterIDs.add(filterID);\n                }\n            }\n        }\n        if ((removed && removed.length !== 0) || (added && added.length !== 0)) {\n            this.updateEnv(env);\n        }\n    }\n    serialize(view) {\n        view.pushUint32(this.excluded.size);\n        for (const filterID of this.excluded) {\n            view.pushUint32(filterID);\n        }\n        view.pushUint32(this.preprocessors.length);\n        for (const preprocessor of this.preprocessors) {\n            preprocessor.serialize(view);\n        }\n    }\n    getSerializedSize() {\n        let estimatedSize = (1 + this.excluded.size) * 4;\n        estimatedSize += 4;\n        for (const preprocessor of this.preprocessors) {\n            estimatedSize += preprocessor.getSerializedSize();\n        }\n        return estimatedSize;\n    }\n}\n//# sourceMappingURL=preprocessor.js.map"],"names":[],"mappings":"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"}